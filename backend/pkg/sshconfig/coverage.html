
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>sshconfig: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">devtools/backend/internal/sshconfig/manager.go (89.6%)</option>
				
				<option value="file1">devtools/backend/internal/sshconfig/validator.go (91.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package sshconfig

import (
        "bufio"
        "fmt"
        "os"
        "path/filepath"
        "regexp"
        "strings"
)

// SSHConfigManager SSH配置管理器
type SSHConfigManager struct {
        filename string
        rawLines []string
}

// HostConfig 主机配置
type HostConfig struct {
        Name        string
        Params      map[string][]Param // 支持多个相同key的参数
        Description string             // Host块的描述信息
        IsGlobal    bool               // 是否为全局配置 (Host *)
}

// Param 配置参数
type Param struct {
        Key   string
        Value string
        Line  int    // 在原文件中的行号
        Raw   string // 原始行内容（包括缩进和注释）
}

// ConfigError 配置相关错误
type ConfigError struct {
        Op  string
        Err error
}

func (e *ConfigError) Error() string <span class="cov8" title="1">{
        return fmt.Sprintf("ssh config %s: %v", e.Op, e.Err)
}</span>

// NewManager 创建新的配置管理器
func NewManager(filename string) (*SSHConfigManager, error) <span class="cov8" title="1">{
        expandedPath := expandHomeDir(filename)

        manager := &amp;SSHConfigManager{
                filename: expandedPath,
        }

        err := manager.Load()
        if err != nil &amp;&amp; !os.IsNotExist(err) </span><span class="cov0" title="0">{
                return nil, &amp;ConfigError{"load", err}
        }</span>

        <span class="cov8" title="1">if os.IsNotExist(err) </span><span class="cov8" title="1">{
                manager.rawLines = []string{}
        }</span>

        <span class="cov8" title="1">return manager, nil</span>
}

// Load 加载配置文件
func (m *SSHConfigManager) Load() error <span class="cov8" title="1">{
        file, err := os.Open(m.filename)
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span>
        <span class="cov8" title="1">defer file.Close()

        var lines []string
        scanner := bufio.NewScanner(file)
        for scanner.Scan() </span><span class="cov8" title="1">{
                lines = append(lines, scanner.Text())
        }</span>

        <span class="cov8" title="1">if err := scanner.Err(); err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">m.rawLines = lines
        return nil</span>
}

// Save 保存配置到文件
func (m *SSHConfigManager) Save() error <span class="cov8" title="1">{
        content := m.BuildConfig()

        dir := filepath.Dir(m.filename)
        if err := os.MkdirAll(dir, 0o755); err != nil </span><span class="cov0" title="0">{
                return &amp;ConfigError{"mkdir", err}
        }</span>

        <span class="cov8" title="1">if err := os.WriteFile(m.filename, []byte(content), 0o600); err != nil </span><span class="cov0" title="0">{
                return &amp;ConfigError{"write", err}
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// BuildConfig 构建配置文件内容
func (m *SSHConfigManager) BuildConfig() string <span class="cov8" title="1">{
        return strings.Join(m.rawLines, "\n") + "\n"
}</span>

// GetHost 获取主机配置
func (m *SSHConfigManager) GetHost(hostname string) (*HostConfig, error) <span class="cov8" title="1">{
        hostStart, hostEnd, found := m.findHost(hostname)
        if !found </span><span class="cov8" title="1">{
                return nil, fmt.Errorf("host %s not found", hostname)
        }</span>

        <span class="cov8" title="1">hostConfig := &amp;HostConfig{
                Name:   hostname,
                Params: make(map[string][]Param),
        }

        if hostEnd == -1 || hostEnd &gt; len(m.rawLines) </span><span class="cov0" title="0">{
                hostEnd = len(m.rawLines)
        }</span>

        // 检查是否为全局配置
        <span class="cov8" title="1">line := strings.TrimSpace(m.rawLines[hostStart])
        if strings.ToLower(line) == "host *" </span><span class="cov8" title="1">{
                hostConfig.IsGlobal = true
        }</span>

        // 查找描述信息（Host行之前的注释）
        <span class="cov8" title="1">if hostStart &gt; 0 </span><span class="cov8" title="1">{
                var comments []string
                for i := hostStart - 1; i &gt;= 0; i-- </span><span class="cov8" title="1">{
                        line := strings.TrimSpace(m.rawLines[i])
                        if line == "" </span><span class="cov8" title="1">{
                                break</span>
                        }
                        <span class="cov8" title="1">if strings.HasPrefix(line, "#") </span><span class="cov8" title="1">{
                                comment := strings.TrimPrefix(line, "#")
                                comments = append([]string{strings.TrimSpace(comment)}, comments...)
                        }</span> else<span class="cov0" title="0"> {
                                break</span>
                        }
                }
                <span class="cov8" title="1">if len(comments) &gt; 0 </span><span class="cov8" title="1">{
                        hostConfig.Description = strings.Join(comments, " ")
                }</span>
        }

        // 解析主机参数
        <span class="cov8" title="1">for i := hostStart + 1; i &lt; hostEnd &amp;&amp; i &lt; len(m.rawLines); i++ </span><span class="cov8" title="1">{
                line := m.rawLines[i]
                trimmed := strings.TrimSpace(line)
                if trimmed == "" || strings.HasPrefix(trimmed, "#") </span><span class="cov8" title="1">{
                        continue</span>
                }

                // 跳过Include等特殊指令
                <span class="cov8" title="1">if strings.HasPrefix(trimmed, "Host ") || strings.HasPrefix(trimmed, "Include ") </span><span class="cov0" title="0">{
                        break</span>
                }

                <span class="cov8" title="1">if key, value := parseParamLine(trimmed); key != "" </span><span class="cov8" title="1">{
                        hostConfig.Params[key] = append(hostConfig.Params[key], Param{
                                Key:   key,
                                Value: value,
                                Line:  i,
                                Raw:   line,
                        })
                }</span>
        }

        <span class="cov8" title="1">return hostConfig, nil</span>
}

// GetAllHosts 获取所有主机配置（包括全局配置）
func (m *SSHConfigManager) GetAllHosts() ([]*HostConfig, error) <span class="cov8" title="1">{
        var hosts []*HostConfig

        for i := 0; i &lt; len(m.rawLines); i++ </span><span class="cov8" title="1">{
                line := strings.TrimSpace(m.rawLines[i])
                if strings.HasPrefix(line, "Host ") </span><span class="cov8" title="1">{
                        hostNames := parseHostNames(strings.TrimPrefix(line, "Host"))
                        for _, hostName := range hostNames </span><span class="cov8" title="1">{
                                // 处理所有主机，包括全局配置
                                host, err := m.GetHost(hostName)
                                if err == nil </span><span class="cov8" title="1">{
                                        hosts = append(hosts, host)
                                }</span>
                        }
                }
        }

        <span class="cov8" title="1">return hosts, nil</span>
}

// GetGlobalConfig 获取全局配置 (Host *)
func (m *SSHConfigManager) GetGlobalConfig() (*HostConfig, error) <span class="cov8" title="1">{
        hostStart, hostEnd, found := m.getGlobalHost()
        if !found </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("global config (Host *) not found")
        }</span>

        <span class="cov8" title="1">hostConfig := &amp;HostConfig{
                Name:     "*",
                Params:   make(map[string][]Param),
                IsGlobal: true,
        }

        if hostEnd == -1 || hostEnd &gt; len(m.rawLines) </span><span class="cov0" title="0">{
                hostEnd = len(m.rawLines)
        }</span>

        // 解析全局参数
        <span class="cov8" title="1">for i := hostStart + 1; i &lt; hostEnd &amp;&amp; i &lt; len(m.rawLines); i++ </span><span class="cov8" title="1">{
                line := m.rawLines[i]
                trimmed := strings.TrimSpace(line)
                if trimmed == "" || strings.HasPrefix(trimmed, "#") </span><span class="cov8" title="1">{
                        continue</span>
                }

                // 跳过Include等特殊指令
                <span class="cov8" title="1">if strings.HasPrefix(trimmed, "Host ") || strings.HasPrefix(trimmed, "Include ") </span><span class="cov0" title="0">{
                        break</span>
                }

                <span class="cov8" title="1">if key, value := parseParamLine(trimmed); key != "" </span><span class="cov8" title="1">{
                        hostConfig.Params[key] = append(hostConfig.Params[key], Param{
                                Key:   key,
                                Value: value,
                                Line:  i,
                                Raw:   line,
                        })
                }</span>
        }

        <span class="cov8" title="1">return hostConfig, nil</span>
}

// AddHost 添加新的主机配置（在文件末尾）
func (m *SSHConfigManager) AddHost(hostname string) *HostConfig <span class="cov8" title="1">{
        hostConfig := &amp;HostConfig{
                Name:   hostname,
                Params: make(map[string][]Param),
        }

        // 如果文件不为空且最后一行不是空行，添加空行分隔
        if len(m.rawLines) &gt; 0 &amp;&amp; strings.TrimSpace(m.rawLines[len(m.rawLines)-1]) != "" </span><span class="cov8" title="1">{
                m.rawLines = append(m.rawLines, "")
        }</span>

        // 添加Host行
        <span class="cov8" title="1">hostLine := fmt.Sprintf("Host %s", hostname)
        m.rawLines = append(m.rawLines, hostLine)

        return hostConfig</span>
}

// SetParam 设置主机参数
func (m *SSHConfigManager) SetParam(hostname, key, value string) error <span class="cov8" title="1">{
        if hostname == "" || key == "" </span><span class="cov8" title="1">{
                return &amp;ConfigError{"set_param", fmt.Errorf("hostname and key cannot be empty")}
        }</span>

        <span class="cov8" title="1">hostStart, hostEnd, found := m.findHost(hostname)
        if !found </span><span class="cov8" title="1">{
                // 如果主机不存在，先添加主机
                m.AddHost(hostname)
                hostStart, hostEnd, _ = m.findHost(hostname)
        }</span>

        // 查找是否已存在该参数
        <span class="cov8" title="1">paramLine := m.findParamInHost(hostStart, hostEnd, key)
        if paramLine != -1 </span><span class="cov8" title="1">{
                // 更新现有参数
                indent := getLineIndent(m.rawLines[paramLine])
                m.rawLines[paramLine] = fmt.Sprintf("%s%s %s", indent, key, value)
        }</span> else<span class="cov8" title="1"> {
                // 添加新参数（在Host行之后）
                newLine := fmt.Sprintf("    %s %s", key, value)
                insertPos := hostStart + 1
                if insertPos &gt;= len(m.rawLines) </span><span class="cov8" title="1">{
                        m.rawLines = append(m.rawLines, newLine)
                }</span> else<span class="cov8" title="1"> {
                        // 在Host块中插入新行
                        lines := append([]string{}, m.rawLines[:insertPos]...)
                        lines = append(lines, newLine)
                        lines = append(lines, m.rawLines[insertPos:]...)
                        m.rawLines = lines
                }</span>
        }

        <span class="cov8" title="1">return nil</span>
}

// RemoveParam 移除主机参数
func (m *SSHConfigManager) RemoveParam(hostname, key string) error <span class="cov8" title="1">{
        if hostname == "" || key == "" </span><span class="cov8" title="1">{
                return &amp;ConfigError{"remove_param", fmt.Errorf("hostname and key cannot be empty")}
        }</span>

        <span class="cov8" title="1">hostStart, hostEnd, found := m.findHost(hostname)
        if !found </span><span class="cov8" title="1">{
                return &amp;ConfigError{"remove_param", fmt.Errorf("host %s not found", hostname)}
        }</span>

        <span class="cov8" title="1">paramLine := m.findParamInHost(hostStart, hostEnd, key)
        if paramLine != -1 </span><span class="cov8" title="1">{
                // 删除参数行
                m.rawLines = append(m.rawLines[:paramLine], m.rawLines[paramLine+1:]...)
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// RemoveHost 移除主机配置
func (m *SSHConfigManager) RemoveHost(hostname string) error <span class="cov8" title="1">{
        if hostname == "" </span><span class="cov8" title="1">{
                return &amp;ConfigError{"remove_host", fmt.Errorf("hostname cannot be empty")}
        }</span>

        <span class="cov8" title="1">hostStart, hostEnd, found := m.findHost(hostname)
        if !found </span><span class="cov8" title="1">{
                return &amp;ConfigError{"remove_host", fmt.Errorf("host %s not found", hostname)}
        }</span>

        // 删除主机块（包括前后空行）
        <span class="cov8" title="1">start := hostStart
        end := hostEnd

        // 包含前面的空行
        for start &gt; 0 &amp;&amp; isBlankLine(m.rawLines[start-1]) </span><span class="cov0" title="0">{
                start--
        }</span>

        // 包含后面的空行
        <span class="cov8" title="1">for end &lt; len(m.rawLines) &amp;&amp; isBlankLine(m.rawLines[end]) </span><span class="cov0" title="0">{
                end++
        }</span>

        <span class="cov8" title="1">m.rawLines = append(m.rawLines[:start], m.rawLines[end:]...)
        return nil</span>
}

// GetParam 获取主机参数值
func (m *SSHConfigManager) GetParam(hostname, key string) (string, error) <span class="cov8" title="1">{
        hostStart, hostEnd, found := m.findHost(hostname)
        if !found </span><span class="cov8" title="1">{
                return "", &amp;ConfigError{"get_param", fmt.Errorf("host %s not found", hostname)}
        }</span>

        <span class="cov8" title="1">if hostEnd == -1 || hostEnd &gt; len(m.rawLines) </span><span class="cov0" title="0">{
                hostEnd = len(m.rawLines)
        }</span>

        // 在主机块中查找参数
        <span class="cov8" title="1">for i := hostStart + 1; i &lt; hostEnd &amp;&amp; i &lt; len(m.rawLines); i++ </span><span class="cov8" title="1">{
                line := strings.TrimSpace(m.rawLines[i])
                if line == "" || strings.HasPrefix(line, "#") </span><span class="cov0" title="0">{
                        continue</span>
                }

                <span class="cov8" title="1">if strings.HasPrefix(line, "Host ") || strings.HasPrefix(line, "Include ") </span><span class="cov0" title="0">{
                        break</span>
                }

                <span class="cov8" title="1">if paramKey, paramValue := parseParamLine(line); paramKey != "" </span><span class="cov8" title="1">{
                        if strings.EqualFold(paramKey, key) </span><span class="cov8" title="1">{
                                return paramValue, nil
                        }</span>
                }
        }

        <span class="cov8" title="1">return "", &amp;ConfigError{"get_param", fmt.Errorf("parameter %s not found for host %s", key, hostname)}</span>
}

// HasHost 检查主机是否存在
func (m *SSHConfigManager) HasHost(hostname string) bool <span class="cov8" title="1">{
        _, _, found := m.findHost(hostname)
        return found
}</span>

// GetHostNames 获取所有主机名（包括*）
func (m *SSHConfigManager) GetHostNames() ([]string, error) <span class="cov8" title="1">{
        var hostNames []string

        for i := 0; i &lt; len(m.rawLines); i++ </span><span class="cov8" title="1">{
                line := strings.TrimSpace(m.rawLines[i])
                if strings.HasPrefix(line, "Host ") </span><span class="cov8" title="1">{
                        names := parseHostNames(strings.TrimPrefix(line, "Host"))
                        hostNames = append(hostNames, names...)
                }</span>
        }

        <span class="cov8" title="1">return hostNames, nil</span>
}

// AddComment 为主机添加注释
func (m *SSHConfigManager) AddComment(hostname, comment string) error <span class="cov8" title="1">{
        hostStart, _, found := m.findHost(hostname)
        if !found </span><span class="cov8" title="1">{
                return &amp;ConfigError{"add_comment", fmt.Errorf("host %s not found", hostname)}
        }</span>

        <span class="cov8" title="1">commentLine := fmt.Sprintf("# %s", comment)

        // 在Host行之前插入注释
        lines := append([]string{}, m.rawLines[:hostStart]...)
        lines = append(lines, commentLine)
        lines = append(lines, m.rawLines[hostStart:]...)
        m.rawLines = lines

        return nil</span>
}

// Validate 验证配置文件语法
// Validate 验证配置文件语法
func (m *SSHConfigManager) Validate() error <span class="cov8" title="1">{
    validator := NewConfigValidator(m.rawLines)
    return validator.Validate()
}</span>

// Backup 创建配置文件备份
func (m *SSHConfigManager) Backup() (string, error) <span class="cov8" title="1">{
        backupPath := m.filename + ".bak"
        content := m.BuildConfig()

        if err := os.WriteFile(backupPath, []byte(content), 0o600); err != nil </span><span class="cov0" title="0">{
                return "", &amp;ConfigError{"backup", err}
        }</span>

        <span class="cov8" title="1">return backupPath, nil</span>
}

// GetIncludes 获取所有Include指令
func (m *SSHConfigManager) GetIncludes() []string <span class="cov8" title="1">{
        var includes []string

        for _, line := range m.rawLines </span><span class="cov8" title="1">{
                trimmed := strings.TrimSpace(line)
                if strings.HasPrefix(trimmed, "Include ") </span><span class="cov8" title="1">{
                        includePath := strings.TrimPrefix(trimmed, "Include ")
                        includes = append(includes, includePath)
                }</span>
        }

        <span class="cov8" title="1">return includes</span>
}

// AddInclude 添加Include指令（在文件开头）
func (m *SSHConfigManager) AddInclude(includePath string) <span class="cov8" title="1">{
        includeLine := fmt.Sprintf("Include %s", includePath)

        // 在文件开头添加Include指令（在现有的Include之后或文件开头）
        insertPos := 0
        for i, line := range m.rawLines </span><span class="cov8" title="1">{
                trimmed := strings.TrimSpace(line)
                if strings.HasPrefix(trimmed, "Include ") </span><span class="cov8" title="1">{
                        insertPos = i + 1
                }</span> else<span class="cov8" title="1"> if trimmed != "" &amp;&amp; !strings.HasPrefix(trimmed, "#") </span><span class="cov8" title="1">{
                        break</span>
                }
        }

        <span class="cov8" title="1">lines := append([]string{}, m.rawLines[:insertPos]...)
        lines = append(lines, includeLine)
        lines = append(lines, m.rawLines[insertPos:]...)
        m.rawLines = lines</span>
}

// SetGlobalParam 设置全局参数
func (m *SSHConfigManager) SetGlobalParam(key, value string) error <span class="cov8" title="1">{
        return m.SetParam("*", key, value)
}</span>

// GetGlobalParam 获取全局参数值
func (m *SSHConfigManager) GetGlobalParam(key string) (string, error) <span class="cov8" title="1">{
        return m.GetParam("*", key)
}</span>

// getGlobalHost 查找全局配置Host *
func (m *SSHConfigManager) getGlobalHost() (start, end int, found bool) <span class="cov8" title="1">{
        for i, line := range m.rawLines </span><span class="cov8" title="1">{
                trimmed := strings.TrimSpace(line)
                if strings.ToLower(trimmed) == "host *" </span><span class="cov8" title="1">{
                        start = i
                        // 查找结束位置（下一个Host或文件结尾）
                        for j := i + 1; j &lt; len(m.rawLines); j++ </span><span class="cov8" title="1">{
                                nextLine := strings.TrimSpace(m.rawLines[j])
                                if strings.HasPrefix(nextLine, "Host ") </span><span class="cov8" title="1">{
                                        end = j
                                        return start, end, true
                                }</span>
                        }
                        <span class="cov0" title="0">end = len(m.rawLines)
                        return start, end, true</span>
                }
        }
        <span class="cov0" title="0">return -1, -1, false</span>
}

// Helper methods

// findHost 查找主机配置的开始和结束行号
func (m *SSHConfigManager) findHost(hostname string) (start, end int, found bool) <span class="cov8" title="1">{
        // 首先尝试精确匹配
        for i, line := range m.rawLines </span><span class="cov8" title="1">{
                trimmed := strings.TrimSpace(line)
                if after, ok := strings.CutPrefix(trimmed, "Host "); ok </span><span class="cov8" title="1">{
                        hostLine := after
                        hostNames := parseHostNames(hostLine)
                        for _, name := range hostNames </span><span class="cov8" title="1">{
                                // 精确匹配
                                if name == hostname </span><span class="cov8" title="1">{
                                        start = i
                                        // 查找结束位置（下一个Host或文件结尾）
                                        for j := i + 1; j &lt; len(m.rawLines); j++ </span><span class="cov8" title="1">{
                                                nextLine := strings.TrimSpace(m.rawLines[j])
                                                if strings.HasPrefix(nextLine, "Host ") </span><span class="cov8" title="1">{
                                                        end = j
                                                        return start, end, true
                                                }</span>
                                        }
                                        <span class="cov8" title="1">end = len(m.rawLines)
                                        return start, end, true</span>
                                }
                        }
                }
        }

        // 如果没有精确匹配，查找通配符匹配
        <span class="cov8" title="1">for i, line := range m.rawLines </span><span class="cov8" title="1">{
                trimmed := strings.TrimSpace(line)
                if after, ok := strings.CutPrefix(trimmed, "Host "); ok </span><span class="cov8" title="1">{
                        hostLine := after
                        hostNames := parseHostNames(hostLine)
                        for _, name := range hostNames </span><span class="cov8" title="1">{
                                // 通配符匹配（除了单独的*）
                                if name != "*" &amp;&amp; matchHostName(name, hostname) </span><span class="cov0" title="0">{
                                        start = i
                                        // 查找结束位置（下一个Host或文件结尾）
                                        for j := i + 1; j &lt; len(m.rawLines); j++ </span><span class="cov0" title="0">{
                                                nextLine := strings.TrimSpace(m.rawLines[j])
                                                if strings.HasPrefix(nextLine, "Host ") </span><span class="cov0" title="0">{
                                                        end = j
                                                        return start, end, true
                                                }</span>
                                        }
                                        <span class="cov0" title="0">end = len(m.rawLines)
                                        return start, end, true</span>
                                }
                        }
                }
        }

        // 注意：不再自动匹配Host *，让调用者决定是否需要全局配置

        <span class="cov8" title="1">return -1, -1, false</span>
}

// findParamInHost 在主机配置块中查找参数
func (m *SSHConfigManager) findParamInHost(start, end int, key string) int <span class="cov8" title="1">{
        if end == -1 || end &gt; len(m.rawLines) </span><span class="cov0" title="0">{
                end = len(m.rawLines)
        }</span>

        <span class="cov8" title="1">for i := start + 1; i &lt; end &amp;&amp; i &lt; len(m.rawLines); i++ </span><span class="cov8" title="1">{
                line := strings.TrimSpace(m.rawLines[i])
                if strings.HasPrefix(line, key+" ") || strings.HasPrefix(line, key+"\t") ||
                        strings.HasPrefix(line, key+"=") </span><span class="cov8" title="1">{
                        return i
                }</span>
                // 遇到下一个Host或Include时停止
                <span class="cov8" title="1">if strings.HasPrefix(line, "Host ") || strings.HasPrefix(line, "Include ") </span><span class="cov0" title="0">{
                        break</span>
                }
        }
        <span class="cov8" title="1">return -1</span>
}

// expandHomeDir 展开家目录路径
func expandHomeDir(path string) string <span class="cov8" title="1">{
        if strings.HasPrefix(path, "~") </span><span class="cov8" title="1">{
                home, err := os.UserHomeDir()
                if err == nil </span><span class="cov8" title="1">{
                        return filepath.Join(home, path[1:])
                }</span>
        }
        <span class="cov8" title="1">return path</span>
}

// GetRawLines 获取原始行（用于调试）
func (m *SSHConfigManager) GetRawLines() []string <span class="cov8" title="1">{
        // 返回副本，避免外部修改内部状态
        lines := make([]string, len(m.rawLines))
        copy(lines, m.rawLines)
        return lines
}</span>

// Helper functions

// parseHostNames 解析Host行中的主机名列表
// parseHostNames 解析Host行中的主机名列表
// parseHostNames 解析Host行中的主机名列表（改进版）
func parseHostNames(hostLine string) []string <span class="cov8" title="1">{
        var names []string

        // 简化版本：使用strings.Fields然后处理引号
        fields := strings.Fields(hostLine)
        for _, field := range fields </span><span class="cov8" title="1">{
                // 移除首尾的引号
                trimmed := strings.Trim(field, "\"'")
                if trimmed != "" </span><span class="cov8" title="1">{
                        names = append(names, trimmed)
                }</span>
        }

        <span class="cov8" title="1">return names</span>
}

// matchHostName 检查主机名是否匹配（支持通配符）
func matchHostName(pattern, hostname string) bool <span class="cov8" title="1">{
        // 精确匹配
        if pattern == hostname </span><span class="cov8" title="1">{
                return true
        }</span>

        // 支持简单的*通配符（但不包括单独的*）
        <span class="cov8" title="1">if strings.Contains(pattern, "*") &amp;&amp; pattern != "*" </span><span class="cov8" title="1">{
                regexPattern := strings.ReplaceAll(regexp.QuoteMeta(pattern), `\*`, `.*`)
                matched, _ := regexp.MatchString("^"+regexPattern+"$", hostname)
                return matched
        }</span>

        <span class="cov8" title="1">return false</span>
}

// parseParamLine 解析参数行
func parseParamLine(line string) (key, value string) <span class="cov8" title="1">{
        // 移除行首的空白
        line = strings.TrimSpace(line)

        // 忽略注释行和特殊指令
        if strings.HasPrefix(line, "#") || strings.HasPrefix(line, "Host ") || strings.HasPrefix(line, "Include ") </span><span class="cov8" title="1">{
                return "", ""
        }</span>

        // 支持 key=value 和 key value 两种格式
        <span class="cov8" title="1">var parts []string
        if strings.Contains(line, "=") &amp;&amp; !strings.Contains(line, " ") </span><span class="cov8" title="1">{
                parts = strings.SplitN(line, "=", 2)
        }</span> else<span class="cov8" title="1"> {
                parts = strings.Fields(line)
        }</span>

        <span class="cov8" title="1">if len(parts) &gt;= 2 </span><span class="cov8" title="1">{
                key = parts[0]
                value = strings.Join(parts[1:], " ")
                return key, value
        }</span> else<span class="cov8" title="1"> if len(parts) == 1 </span><span class="cov8" title="1">{
                key = parts[0]
                return key, ""
        }</span>

        <span class="cov8" title="1">return "", ""</span>
}

// getLineIndent 获取行的缩进
func getLineIndent(line string) string <span class="cov8" title="1">{
        for i, char := range line </span><span class="cov8" title="1">{
                if char != ' ' &amp;&amp; char != '\t' </span><span class="cov8" title="1">{
                        return line[:i]
                }</span>
        }
        <span class="cov0" title="0">return line</span>
}

// isBlankLine 检查是否为空行
func isBlankLine(line string) bool <span class="cov8" title="1">{
        return strings.TrimSpace(line) == ""
}</span>
</pre>
		
		<pre class="file" id="file1" style="display: none">package sshconfig

import (
        "fmt"
        "strings"
)

// ConfigValidator SSH配置验证器
type ConfigValidator struct {
        lines []string
}

// NewConfigValidator 创建新的配置验证器
func NewConfigValidator(lines []string) *ConfigValidator <span class="cov8" title="1">{
        return &amp;ConfigValidator{
                lines: lines,
        }
}</span>

// Validate 验证配置文件语法
func (v *ConfigValidator) Validate() error <span class="cov8" title="1">{
        for i, line := range v.lines </span><span class="cov8" title="1">{
                lineNumber := i + 1
                trimmed := strings.TrimSpace(line)

                // 跳过空行和注释行
                if trimmed == "" || strings.HasPrefix(trimmed, "#") </span><span class="cov8" title="1">{
                        continue</span>
                }

                // 验证配置行
                <span class="cov8" title="1">if err := v.validateConfigLine(line, lineNumber); err != nil </span><span class="cov8" title="1">{
                        return err
                }</span>
        }

        <span class="cov8" title="1">return nil</span>
}

// validateConfigLine 验证单个配置行
func (v *ConfigValidator) validateConfigLine(line string, lineNumber int) error <span class="cov8" title="1">{
    // Host指令验证 - 检查原始行是否以"Host "开头
    if strings.HasPrefix(line, "Host ") </span><span class="cov8" title="1">{
        return v.validateHostLine(line, lineNumber)
    }</span>
    
    // Include指令验证
    <span class="cov8" title="1">if strings.HasPrefix(line, "Include ") </span><span class="cov8" title="1">{
        return v.validateIncludeLine(line, lineNumber)
    }</span>
    
    // Match指令验证（可选支持）
    <span class="cov8" title="1">if strings.HasPrefix(line, "Match ") </span><span class="cov8" title="1">{
        return v.validateMatchLine(line, lineNumber)
    }</span>
    
    // 参数行验证
    <span class="cov8" title="1">return v.validateParamLine(line, lineNumber)</span>
}

// validateHostLine 验证Host行
func (v *ConfigValidator) validateHostLine(line string, lineNumber int) error <span class="cov8" title="1">{
    if !strings.HasPrefix(line, "Host ") </span><span class="cov0" title="0">{
        return &amp;ConfigError{"validate", fmt.Errorf("line %d: not a valid Host line", lineNumber)}
    }</span>
    
    <span class="cov8" title="1">hostPart := strings.TrimPrefix(line, "Host ")
    trimmedHostPart := strings.TrimSpace(hostPart)
    
    if trimmedHostPart == "" </span><span class="cov8" title="1">{
        return &amp;ConfigError{"validate", fmt.Errorf("line %d: Host directive requires at least one hostname", lineNumber)}
    }</span>

    // 验证主机名格式
    <span class="cov8" title="1">hostNames := parseHostNames(trimmedHostPart)
    if len(hostNames) == 0 </span><span class="cov0" title="0">{
        return &amp;ConfigError{"validate", fmt.Errorf("line %d: Host directive requires at least one hostname", lineNumber)}
    }</span>

    <span class="cov8" title="1">for _, hostname := range hostNames </span><span class="cov8" title="1">{
        if err := v.validateHostname(hostname); err != nil </span><span class="cov0" title="0">{
            return &amp;ConfigError{"validate", fmt.Errorf("line %d: invalid hostname '%s': %v", lineNumber, hostname, err)}
        }</span>
    }

    <span class="cov8" title="1">return nil</span>
}

// validateIncludeLine 验证Include行
func (v *ConfigValidator) validateIncludeLine(line string, lineNumber int) error <span class="cov8" title="1">{
    if !strings.HasPrefix(line, "Include ") </span><span class="cov0" title="0">{
        return &amp;ConfigError{"validate", fmt.Errorf("line %d: not a valid Include line", lineNumber)}
    }</span>
    
    <span class="cov8" title="1">includePart := strings.TrimPrefix(line, "Include ")
    trimmedIncludePart := strings.TrimSpace(includePart)
    
    if trimmedIncludePart == "" </span><span class="cov8" title="1">{
        return &amp;ConfigError{"validate", fmt.Errorf("line %d: Include directive requires a path", lineNumber)}
    }</span>
    
    // 基本路径格式验证
    <span class="cov8" title="1">if strings.Contains(includePart, "\n") </span><span class="cov8" title="1">{
        return &amp;ConfigError{"validate", fmt.Errorf("line %d: Include path cannot contain newlines", lineNumber)}
    }</span>
    
    <span class="cov8" title="1">return nil</span>
}

// validateParamLine 验证参数行
func (v *ConfigValidator) validateParamLine(line string, lineNumber int) error <span class="cov8" title="1">{
        trimmed := strings.TrimSpace(line)

        // 参数行必须有缩进（空格或制表符）
        if len(line) &gt; 0 &amp;&amp; line[0] != ' ' &amp;&amp; line[0] != '\t' </span><span class="cov8" title="1">{
                return &amp;ConfigError{"validate", fmt.Errorf("line %d: parameter lines must be indented", lineNumber)}
        }</span>

        // 解析参数
        <span class="cov8" title="1">key, value := parseParamLine(trimmed)
        if key == "" &amp;&amp; trimmed != "" </span><span class="cov0" title="0">{
                return &amp;ConfigError{"validate", fmt.Errorf("line %d: invalid parameter format", lineNumber)}
        }</span>

        // 验证参数值（基本验证）
        <span class="cov8" title="1">if err := v.validateParamValue(key, value, lineNumber); err != nil </span><span class="cov8" title="1">{
                return err
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// validateMatchLine 验证Match行
func (v *ConfigValidator) validateMatchLine(line string, lineNumber int) error <span class="cov8" title="1">{
        matchPart := strings.TrimPrefix(strings.TrimSpace(line), "Match ")
        if strings.TrimSpace(matchPart) == "" </span><span class="cov0" title="0">{
                return &amp;ConfigError{"validate", fmt.Errorf("line %d: Match directive requires criteria", lineNumber)}
        }</span>

        // 基本验证
        <span class="cov8" title="1">validCriteria := []string{"User", "Host", "Address", "LocalAddress", "LocalPort", "RDomain", "Canonical", "All"}
        criteria := strings.Fields(matchPart)

        for i := 0; i &lt; len(criteria); i += 2 </span><span class="cov8" title="1">{
                if i+1 &gt;= len(criteria) </span><span class="cov8" title="1">{
                        return &amp;ConfigError{"validate", fmt.Errorf("line %d: Match criteria incomplete", lineNumber)}
                }</span>

                <span class="cov8" title="1">criterion := criteria[i]
                value := criteria[i+1]

                valid := false
                for _, validCriterion := range validCriteria </span><span class="cov8" title="1">{
                        if strings.EqualFold(criterion, validCriterion) </span><span class="cov8" title="1">{
                                valid = true
                                break</span>
                        }
                }

                <span class="cov8" title="1">if !valid </span><span class="cov8" title="1">{
                        return &amp;ConfigError{"validate", fmt.Errorf("line %d: invalid Match criterion '%s'", lineNumber, criterion)}
                }</span>

                // 验证值格式
                <span class="cov8" title="1">if strings.TrimSpace(value) == "" </span><span class="cov0" title="0">{
                        return &amp;ConfigError{"validate", fmt.Errorf("line %d: Match criterion '%s' requires a value", lineNumber, criterion)}
                }</span>
        }

        <span class="cov8" title="1">return nil</span>
}

// validateParamValue 验证参数值
func (v *ConfigValidator) validateParamValue(key, value string, lineNumber int) error <span class="cov8" title="1">{
        // 常见参数的值验证
        switch strings.ToLower(key) </span>{
        case "port":<span class="cov8" title="1">
                if value != "" </span><span class="cov8" title="1">{
                        if !v.isNumeric(value) </span><span class="cov8" title="1">{
                                return &amp;ConfigError{"validate", fmt.Errorf("line %d: Port must be numeric", lineNumber)}
                        }</span>
                        <span class="cov8" title="1">port := v.parseInt(value)
                        if port &lt; 1 || port &gt; 65535 </span><span class="cov8" title="1">{
                                return &amp;ConfigError{"validate", fmt.Errorf("line %d: Port must be between 1 and 65535", lineNumber)}
                        }</span>
                }
        case "serveraliveinterval", "serveralivemaxcount", "connecttimeout":<span class="cov8" title="1">
                if value != "" &amp;&amp; !v.isNumeric(value) </span><span class="cov0" title="0">{
                        return &amp;ConfigError{"validate", fmt.Errorf("line %d: %s must be numeric", lineNumber, key)}
                }</span>
        case "compression", "tcpkeepalive", "usedns", "useprivilegedport", "stricthostkeychecking":<span class="cov8" title="1">
                if value != "" &amp;&amp; !v.isValidYesNo(value) </span><span class="cov8" title="1">{
                        return &amp;ConfigError{"validate", fmt.Errorf("line %d: %s must be 'yes' or 'no'", lineNumber, key)}
                }</span>
        case "protocol":<span class="cov8" title="1">
                if value != "" &amp;&amp; value != "1" &amp;&amp; value != "2" </span><span class="cov8" title="1">{
                        return &amp;ConfigError{"validate", fmt.Errorf("line %d: Protocol must be '1' or '2'", lineNumber)}
                }</span>
        }

        <span class="cov8" title="1">return nil</span>
}

// validateHostname 验证主机名格式
func (v *ConfigValidator) validateHostname(hostname string) error <span class="cov8" title="1">{
        if hostname == "" </span><span class="cov8" title="1">{
                return fmt.Errorf("hostname cannot be empty")
        }</span>

        // 通配符是允许的
        <span class="cov8" title="1">if hostname == "*" </span><span class="cov8" title="1">{
                return nil
        }</span>

        // 基本格式检查
        <span class="cov8" title="1">if len(hostname) &gt; 253 </span><span class="cov0" title="0">{
                return fmt.Errorf("hostname too long")
        }</span>

        // 不进行严格的DNS格式验证，因为SSH配置允许各种格式
        <span class="cov8" title="1">return nil</span>
}

// 辅助验证函数
func (v *ConfigValidator) isNumeric(s string) bool <span class="cov8" title="1">{
        if s == "" </span><span class="cov8" title="1">{
                return false
        }</span>
        <span class="cov8" title="1">for _, c := range s </span><span class="cov8" title="1">{
                if c &lt; '0' || c &gt; '9' </span><span class="cov8" title="1">{
                        return false
                }</span>
        }
        <span class="cov8" title="1">return true</span>
}

func (v *ConfigValidator) parseInt(s string) int <span class="cov8" title="1">{
        result := 0
        for _, c := range s </span><span class="cov8" title="1">{
                result = result*10 + int(c-'0')
        }</span>
        <span class="cov8" title="1">return result</span>
}

func (v *ConfigValidator) isValidYesNo(s string) bool <span class="cov8" title="1">{
        lower := strings.ToLower(s)
        return lower == "yes" || lower == "no" || lower == "true" || lower == "false"
}</span>
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
